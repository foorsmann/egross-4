(function(){"use strict";var __webpack_exports__={};function _defineProperty(obj,key,value){if(key in obj){Object.defineProperty(obj,key,{value:value,enumerable:true,configurable:true,writable:true})}else{obj[key]=value}return obj}if(!customElements.get("product-form")){customElements.define("product-form",class ProductForm extends HTMLElement{constructor(){super();_defineProperty(this,"toggleSpinner",show=>{const method=show?"add":"remove";this.form.closest(".product-form").classList[method]("adding")});this.selectors={form:"form",inputId:"[name=id]",submitButton:'[name="add"]',errorWrapper:".prod__form-error",customFields:["[data-product-custom-field]"],dynamicCheckout:".prod__dynamic_checkout"};this.domNodes=queryDomNodes(this.selectors,this);this.form=this.domNodes.form;this.submitButton=this.domNodes.submitButton;this.domNodes.inputId.disabled=false;this.notificationType=this.dataset.notificationType;this.customFields=document.querySelectorAll(this.selectors.customFields);if(this.domNodes.dynamicCheckout)this.enable_dynamic_checkout=true;this.form.addEventListener("submit",this.onSubmitHandler.bind(this));if(this.domNodes.dynamicCheckout&&this.customFields){this.domNodes.dynamicCheckout.addEventListener("click",e=>{const missing=validateForm(this.form.closest(".main-product__blocks"));if(missing.length>0){e.stopPropagation();window.ConceptSGMTheme.Notification.show({target:this.domNodes.errorWrapper,method:"appendChild",type:"warning",message:window.ConceptSGMStrings.requiredField,delay:100})}},true)}}async onSubmitHandler(evt){evt.preventDefault();this.toggleSpinner(true);const missing=validateForm(this.form.closest(".main-product__blocks"));if(missing?.length>0){this.toggleSpinner(false);return window.ConceptSGMTheme.Notification.show({target:this?.domNodes?.errorWrapper,method:"appendChild",type:"warning",message:window.ConceptSGMStrings.requiredField})}const formData=new FormData(this.form);const variantId=parseInt(formData.get("id"),10);const requestedQty=parseInt(formData.get("quantity"))||1;const qtyInput=this.form.querySelector('[name="quantity"]');const maxQty=parseInt(qtyInput?.max)||Infinity;let resetQty=false;let cartQty=0;try{const cart=await fetch("/cart.js").then(r=>r.json());cartQty=cart.items?.find(itm=>itm.variant_id===variantId)?.quantity||0}catch(err){cartQty=0}const availableToAdd=Math.max(maxQty-cartQty,0);if(availableToAdd<=0){this.toggleSpinner(false);return window.ConceptSGMTheme.Notification.show({target:this?.domNodes?.errorWrapper,method:"appendChild",type:"warning",message:window.ConceptSGMStrings.cartLimit||"Cantitatea maxima pentru aceasta varianta este deja in cos."})}if(requestedQty>availableToAdd){formData.set("quantity",availableToAdd);if(qtyInput){resetQty=true}}const config={method:"POST",headers:{Accept:"application/javascript","X-Requested-With":"XMLHttpRequest"},body:formData};const{ConceptSGMSettings:ConceptSGMSettings,ConceptSGMStrings:ConceptSGMStrings}=window;if(ConceptSGMSettings.use_ajax_atc){fetch(`${ConceptSGMSettings.routes.cart_add_url}`,config).then(async r=>{let body;try{const ct=r.headers.get("content-type");if(ct&&ct.includes("application/json")){body=await r.json()}else{const text=await r.text();body={message:text}}}catch(err){body={}}return{statusCode:r.status,body:body}}).then(({statusCode:statusCode,body:body})=>{if(statusCode>=400||body.status){let msg=body.description||body.message||body.errors||window.ConceptSGMStrings.cartError;if(statusCode===429){msg="Ati trimis prea multe cereri. Va rugam sa incercati din nou mai tarziu."}return window.ConceptSGMTheme.Notification.show({target:this.notificationType==="toast"?document.body:this.domNodes.errorWrapper,method:"appendChild",type:"warning",message:msg,last:3e3,sticky:this.notificationType==="toast"})}if(!ConceptSGMSettings.enable_cart_drawer){window.ConceptSGMTheme.Notification.show({target:this.domNodes.errorWrapper,method:"appendChild",type:"success",message:window.ConceptSGMStrings.itemAdded,last:3e3,sticky:this.notificationType==="toast"})}window.ConceptSGMEvents.emit(`ON_ITEM_ADDED`,body);window.Shopify.onItemAdded(body);if(resetQty&&qtyInput){qtyInput.dataset.prevMin=qtyInput.min;qtyInput.dataset.prevMinQtyAttr=qtyInput.getAttribute("data-min-qty");qtyInput.removeAttribute("data-min-qty");qtyInput.min=0;qtyInput.value=0;qtyInput.classList.add("text-red-600");qtyInput.style.color="#e3342f";if(typeof updateQtyButtonsState==="function"){updateQtyButtonsState(qtyInput)}const reinforceZero=()=>{qtyInput.value=0;if(typeof updateQtyButtonsState==="function"){updateQtyButtonsState(qtyInput)}};setTimeout(reinforceZero,0);const clearWarning=()=>{qtyInput.classList.remove("text-red-600");qtyInput.style.color="";if(qtyInput.dataset.prevMin){qtyInput.min=qtyInput.dataset.prevMin;delete qtyInput.dataset.prevMin}if(qtyInput.dataset.prevMinQtyAttr!==undefined){qtyInput.setAttribute("data-min-qty",qtyInput.dataset.prevMinQtyAttr);delete qtyInput.dataset.prevMinQtyAttr}qtyInput.removeEventListener("input",clearWarning);qtyInput.removeEventListener("change",clearWarning)};qtyInput.addEventListener("input",clearWarning,{once:true});qtyInput.addEventListener("change",clearWarning,{once:true})}}).catch(()=>{}).finally(()=>{this.toggleSpinner(false)})}else{this.form.submit()}}})}})();